<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Air780E çŸ­ä¿¡æ§åˆ¶å°</title>
<style>
  :root { --blue:#007aff; --bg:#f6f6f6; }
  body { font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial; margin:20px; max-width:820px; }
  h2 { text-align:center; margin-top:0; }
  .row { display:flex; gap:10px; align-items:center; margin:10px 0; }
  .grow { flex:1 1 auto; }
  input, textarea, select { width:100%; font-size:16px; margin-top:6px; padding:8px; box-sizing:border-box; }
  button { padding:10px 14px; background:var(--blue); color:#fff; border:0; border-radius:8px; font-size:16px; cursor:pointer; }
  button.ghost { background:#e9eef9; color:#1a1a1a; }
  #status { margin:8px 0 14px; text-align:center; color:#666; font-size:14px; }
  #log { margin-top:18px; font-family:monospace; background:var(--bg); border-radius:6px; padding:10px; height:200px; overflow-y:auto; white-space:pre-wrap; }
  .section { background:#fff; padding:12px; border-radius:8px; box-shadow:0 1px 2px rgba(0,0,0,.04); margin-top:12px; }
  table { width:100%; border-collapse:collapse; background:#fff; }
  th, td { padding:8px; border-bottom:1px solid #eee; font-size:14px; }
  tr.clickable { cursor:pointer; }
  tr.clickable:hover { background:#fafafa; }
  .pill { font-size:12px; background:#eef2ff; color:#334155; padding:2px 8px; border-radius:999px; }
  .status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .online { background:#16a34a; }  .offline { background:#9ca3af; }
</style>
</head>
<body>

<h2>ğŸ“© Air780E çŸ­ä¿¡æ§åˆ¶å°</h2>
<div id="status">åˆå§‹åŒ–ä¸­...</div>

<div class="section">
  <div class="row">
    <div class="grow">
      <label>é€‰æ‹©è®¾å¤‡</label>
      <select id="deviceSelect"></select>
    </div>
    <div>
      <button id="refreshDevicesBtn" class="ghost">åˆ·æ–°è®¾å¤‡</button>
    </div>
    <div><span class="pill" id="devicesInfo">â€”</span></div>
  </div>
  <table id="devicesTable">
    <thead><tr><th>è®¾å¤‡ID</th><th>çŠ¶æ€</th><th>æœ€ååœ¨çº¿</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <div class="row">
    <div class="grow"><strong>ä¸´æ—¶é€šè®¯å½•</strong></div>
    <button id="refreshContactsBtn" class="ghost">åˆ·æ–°é€šè®¯å½•</button>
    <span class="pill" id="contactsInfo">â€”</span>
  </div>
  <table id="contactsTable">
    <thead><tr><th>å·ç </th><th>å§“å</th><th>æœ€è¿‘å‡ºç°</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <label>å‘é€ç»™ (æ‰‹æœºå·)</label>
  <input id="to" type="text" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
  <label style="margin-top:8px; display:block;">çŸ­ä¿¡å†…å®¹</label>
  <textarea id="content" rows="4" placeholder="è¯·è¾“å…¥è¦å‘é€çš„å†…å®¹"></textarea>
  <div class="row">
    <button id="sendBtn" class="grow">å‘é€çŸ­ä¿¡</button>
    <button id="clearBtn" class="ghost">æ¸…ç©º</button>
  </div>
</div>

<div id="log" class="section" style="height:auto; max-height:220px;"></div>

<script>
  (async function(){
    const statusEl   = document.getElementById("status");
    const logEl      = document.getElementById("log");
    const deviceSel  = document.getElementById("deviceSelect");
    const devicesTbl = document.querySelector("#devicesTable tbody");
    const devicesInfo= document.getElementById("devicesInfo");
    const refreshDev = document.getElementById("refreshDevicesBtn");
  
    const contactsTbl= document.querySelector("#contactsTable tbody");
    const contactsInfo = document.getElementById("contactsInfo");
    const refreshCt  = document.getElementById("refreshContactsBtn");
  
    const toEl       = document.getElementById("to");
    const contentEl  = document.getElementById("content");
    const sendBtn    = document.getElementById("sendBtn");
    const clearBtn   = document.getElementById("clearBtn");
  
    function appendLog(msg, color="#333") {
      const line = document.createElement("div");
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      line.style.color = color;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }
  
    const fmtTime = ts => {
      if (!ts) return "-";
      const ms = ts > 1e12 ? ts : ts*1000;
      return new Date(ms).toLocaleString();
    };
    const statusDot = s => `<span class="status-dot ${s==='online'?'online':'offline'}"></span>${s||'-'}`;
  
    // 1ï¸âƒ£ è·å–çŸ­æœŸ JWT
    statusEl.textContent = "æ­£åœ¨è¯·æ±‚ JWT ä»¤ç‰Œ...";
    let token;
    try {
      const r = await fetch("/token", { credentials: "include" });
      if (!r.ok) throw new Error(r.statusText);
      ({ token } = await r.json());
      appendLog("âœ… æˆåŠŸè·å– JWT ä»¤ç‰Œ");
    } catch (e) {
      statusEl.textContent = "âŒ æ— æ³•è·å–ä»¤ç‰Œï¼ˆå¯èƒ½æœªé€šè¿‡ Access æˆæƒï¼‰";
      appendLog("è·å– JWT å¤±è´¥: " + e.message, "red");
      return;
    }
  
    // 2ï¸âƒ£ å»ºç«‹ WebSocketï¼ˆä»…ä¸€æ¬¡ï¼Œä¸è‡ªåŠ¨é‡è¿ï¼‰
    let ws = null;
    let wsAttempted = false;
  
    async function openWSOnce() {
      if (wsAttempted) return ws;
      wsAttempted = true;
  
      statusEl.textContent = "æ­£åœ¨è¿æ¥ WebSocket...";
      const wsUrl = `wss://${location.host}/ws?token=${encodeURIComponent(token)}`;
      ws = new WebSocket(wsUrl);
  
      ws.addEventListener("open", () => {
        statusEl.textContent = "âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼ˆä¸è‡ªåŠ¨é‡è¿ï¼‰";
        appendLog("WebSocket å·²è¿æ¥", "green");
        sendBtn.disabled = false;
      });
  
      ws.addEventListener("message", (e) => {
        appendLog("WS: " + e.data);
      });
  
      // æ–­å¼€/é”™è¯¯åä¸å†è‡ªåŠ¨é‡è¿
      function markClosed(reason) {
        sendBtn.disabled = true;
        statusEl.textContent = `âš ï¸ è¿æ¥å·²å…³é—­ï¼š${reason || "å·²æ–­å¼€"}`;
        appendLog(`WebSocket å·²å…³é—­ï¼š${reason || ""}`, "red");
      }
  
      ws.addEventListener("close", (ev) => {
        markClosed(`code=${ev.code}`);
      });
      ws.addEventListener("error", (e) => {
        markClosed("å‘ç”Ÿé”™è¯¯");
      });
  
      return ws;
    }
  
    await openWSOnce();
  
    // 3ï¸âƒ£ åŠ è½½è®¾å¤‡åˆ—è¡¨
    async function fetchDevices() {
      devicesTbl.innerHTML = "";
      devicesInfo.textContent = "åŠ è½½ä¸­â€¦";
      try {
        const r = await fetch("/devices", { credentials: "include" });
        if (!r.ok) throw new Error(r.statusText);
        const list = await r.json();
        devicesInfo.textContent = `å…± ${list.length} å°`;
        deviceSel.innerHTML = "";
        list.forEach((d,i) => {
          const opt = document.createElement("option");
          opt.value = d.device_id;
          opt.textContent = `${d.device_id} (${d.status||'-'})`;
          if (i===0) opt.selected = true;
          deviceSel.appendChild(opt);
  
          const tr = document.createElement("tr");
          tr.className = "clickable";
          tr.innerHTML = `<td>${d.device_id}</td><td>${statusDot(d.status)}</td><td>${fmtTime(d.last_seen)}</td>`;
          tr.addEventListener("click", () => {
            deviceSel.value = d.device_id;
            fetchContacts();
          });
          devicesTbl.appendChild(tr);
        });
        if (list.length) fetchContacts();
        else { contactsTbl.innerHTML = ""; contactsInfo.textContent = "æ— è®¾å¤‡"; }
      } catch (e) {
        devicesInfo.textContent = "åŠ è½½å¤±è´¥";
        appendLog("åŠ è½½è®¾å¤‡å¤±è´¥: " + e.message, "red");
      }
    }
    refreshDev.addEventListener("click", fetchDevices);
    deviceSel.addEventListener("change", fetchContacts);
    await fetchDevices();
  
    // 4ï¸âƒ£ åŠ è½½é€šè®¯å½•
    async function fetchContacts() {
      contactsTbl.innerHTML = "";
      const dev = deviceSel.value;
      if (!dev) { contactsInfo.textContent = "æœªé€‰æ‹©è®¾å¤‡"; return; }
      contactsInfo.textContent = "åŠ è½½ä¸­â€¦";
      try {
        let r = await fetch(`/contacts/${encodeURIComponent(dev)}`, { credentials: "include" });
        if (!r.ok) r = await fetch(`/contacts?device=${encodeURIComponent(dev)}`, { credentials: "include" });
        if (!r.ok) throw new Error(r.statusText);
        const list = await r.json();
        contactsInfo.textContent = `å…± ${list.length} ä¸ª`;
        list.forEach(c => {
          const tr = document.createElement("tr");
          tr.className = "clickable";
          tr.innerHTML = `<td>${c.number}</td><td>${c.name || "-"}</td><td>${fmtTime(c.last_seen)}</td>`;
          tr.addEventListener("click", () => {
            toEl.value = c.number;
            appendLog(`é€‰æ‹©è”ç³»äºº: ${c.number}${c.name?("ï¼ˆ"+c.name+"ï¼‰"):""}`);
          });
          contactsTbl.appendChild(tr);
        });
      } catch (e) {
        contactsInfo.textContent = "åŠ è½½å¤±è´¥";
        appendLog("åŠ è½½é€šè®¯å½•å¤±è´¥: " + e.message, "red");
      }
    }
    refreshCt.addEventListener("click", fetchContacts);
  
    // 5ï¸âƒ£ å‘é€çŸ­ä¿¡
    sendBtn.onclick = function() {
      const dev = deviceSel.value;
      const to = toEl.value.trim();
      const content = contentEl.value.trim();
      if (!dev || !to || !content) {
        alert("è¯·é€‰æ‹©è®¾å¤‡å¹¶å¡«å†™æ‰‹æœºå·ä¸å†…å®¹");
        return;
      }
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        appendLog("WebSocket æœªè¿æ¥ï¼ˆè¯·åˆ·æ–°é¡µé¢é‡æ–°è·å–è¿æ¥ï¼‰", "red");
        alert("è¿æ¥æœªå°±ç»ªï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•");
        return;
      }
  
      const msg = {
        action: "publish",
        topic: `air780e/command/${dev}`,
        payload: { command: "send_sms", to, content }
      };
      ws.send(JSON.stringify(msg));
      appendLog(`ğŸ“¤ å‘é€ç»™ ${to}: ${content}`, "blue");
      contentEl.value = "";
    };
  
    clearBtn.onclick = () => { toEl.value = ""; contentEl.value = ""; };
  })();
  </script>
</body>
</html>