<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Air780E SMS Reply</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial;
  margin: 20px; max-width: 500px;
}
h2 { text-align: center; }
input, textarea { width: 100%; font-size: 16px; margin-top: 8px; box-sizing: border-box; }
button {
  width: 100%; padding: 10px; margin-top: 15px;
  background-color: #007aff; color: #fff; font-size: 17px;
  border: none; border-radius: 8px;
}
#status { margin-bottom: 10px; text-align: center; color: #666; font-size: 14px; }
</style>
</head>
<body>

<h2>ğŸ“© å›å¤çŸ­ä¿¡</h2>
<div id="status">æ­£åœ¨åˆå§‹åŒ–...</div>

<label>å‘é€ç»™ (æ‰‹æœºå·):</label>
<input id="to" type="text" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />

<label>çŸ­ä¿¡å†…å®¹:</label>
<textarea id="content" rows="5" placeholder="è¯·è¾“å…¥è¦å‘é€çš„å†…å®¹"></textarea>

<button id="sendBtn">å‘é€çŸ­ä¿¡</button>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const device = qs.get("device") || "";
  const toParam = qs.get("to") || "";
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("sendBtn");
  const toInput = document.getElementById("to");
  const contentInput = document.getElementById("content");
  toInput.value = toParam;

  // ä¿®æ”¹ä¸ºä½ çš„åŸŸå
  const WS_URL = "wss://broker.dagow.me/ws";
  
  let ws, token;

  async function getToken() {
    try {
      const r = await fetch("/token", { credentials: "include" });
      if (!r.ok) throw new Error("Token è¯·æ±‚å¤±è´¥: " + r.status);
      const data = await r.json();
      token = data.token;
      return token;
    } catch (e) {
      statusEl.textContent = "âŒ æœªç™»å½•æˆ– Token è·å–å¤±è´¥ï¼Œè¯·ç™»å½•ååˆ·æ–°é¡µé¢ã€‚";
      console.error("Token error:", e);
      return null;
    }
  }

  async function connect() {
    if (!token) {
      token = await getToken();
      if (!token) return; // æ²¡æœ‰ token å°±ä¸å†ç»§ç»­
    }

    statusEl.textContent = "ğŸ”Œ æ­£åœ¨è¿æ¥ WebSocket...";
    ws = new WebSocket(WS_URL + "?jwt=" + encodeURIComponent(token));

    ws.onopen = () => {
      statusEl.textContent = "âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨";
    };

    ws.onmessage = (evt) => {
      console.log("æ”¶åˆ°æ¶ˆæ¯:", evt.data);
      try {
        const msg = JSON.parse(evt.data);
        if (msg.topic && msg.payload) {
          statusEl.textContent = "ğŸ“¬ æ”¶åˆ°åé¦ˆ: " + JSON.stringify(msg.payload);
        }
      } catch {
        statusEl.textContent = "ğŸ“© æ”¶åˆ°åŸå§‹æ¶ˆæ¯";
      }
    };

    ws.onclose = () => {
      statusEl.textContent = "âš ï¸ è¿æ¥æ–­å¼€ï¼Œ5ç§’åé‡è¯•...";
      setTimeout(connect, 5000);
    };

    ws.onerror = (err) => {
      console.error("WebSocket é”™è¯¯:", err);
      statusEl.textContent = "âš ï¸ WebSocket é”™è¯¯";
    };
  }

  btn.onclick = function() {
    const to = toInput.value.trim();
    const msg = contentInput.value.trim();
    if (!to || !msg) { alert("è¯·è¾“å…¥æ‰‹æœºå·å’Œå†…å®¹"); return; }
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      alert("WebSocket æœªè¿æ¥ï¼Œè¯·ç¨åå†è¯•");
      return;
    }

    const topic = "air780e/command/" + device;
    const payload = {
      command: "send_sms",
      to, content: msg
    };
    const data = { action: "publish", topic, payload };
    ws.send(JSON.stringify(data));
    statusEl.textContent = "ğŸ“¤ å·²å‘é€åˆ°è®¾å¤‡ï¼š" + to;
    contentInput.value = "";
  };

  await connect();
})();
</script>
</body>
</html>